# TASK-006: Создание GoogleSheetsSyncService

## Статус: ✅ Выполнено

**Дата создания:** 2025-01-30  
**Приоритет:** Критический  
**Зависимости:** TASK-002, TASK-004, TASK-005

---

## Описание

Создать сервис для синхронизации данных между Google Sheets и базой данных. Сервис должен читать данные из таблицы, парсить их, находить соответствующие миграции и создавать/обновлять записи в таблице `migration_reviewers`.

## Что нужно сделать

### 1. Создать файл сервиса

**Файл:** `dashboard/api/services/GoogleSheetsSyncService.php`

### 2. Реализовать класс GoogleSheetsSyncService

**Namespace:** `Dashboard\Services`

**Зависимости:**
- `GoogleSheetsService` - для работы с Google API
- `DatabaseService` - для работы с БД

**Основные методы:**

#### `syncSheet($spreadsheetId, $sheetName, $waveId = null)`
Основной метод синхронизации:
1. Получить данные листа через `GoogleSheetsService`
2. Распарсить данные (UUID и Person Brizy)
3. Для каждой строки:
   - Найти миграцию в таблице `migrations` по UUID
   - Если миграция найдена, создать/обновить запись в `migration_reviewers`
4. Обновить `last_synced_at` в таблице `google_sheets`
5. Вернуть статистику синхронизации

#### `syncAllSheets()`
Синхронизировать все подключенные таблицы

#### `findMigrationByUuid($uuid)`
Найти миграцию в таблице `migrations` по UUID

#### `upsertMigrationReviewer($migrationId, $uuid, $personBrizy)`
Создать или обновить запись в `migration_reviewers`

---

## Ожидаемые результаты

### Проверка синхронизации одной таблицы

- [ ] Метод `syncSheet()` успешно получает данные из Google Sheets
- [ ] Данные корректно парсятся (UUID и Person Brizy извлекаются)
- [ ] Для каждого UUID находится соответствующая миграция в БД
- [ ] Записи в `migration_reviewers` создаются/обновляются корректно
- [ ] `last_synced_at` обновляется в таблице `google_sheets`
- [ ] Возвращается статистика: количество обработанных строк, созданных записей, обновленных записей

### Проверка обработки отсутствующих миграций

- [ ] Если миграция с UUID не найдена, запись не создается (или создается с migration_id = NULL)
- [ ] Логируется предупреждение о не найденных миграциях
- [ ] Статистика включает количество не найденных миграций

### Проверка обновления существующих записей

- [ ] Если запись в `migration_reviewers` уже существует, она обновляется
- [ ] `updated_at` обновляется при изменении данных
- [ ] Не создаются дубликаты записей

### Проверка синхронизации всех таблиц

- [ ] Метод `syncAllSheets()` находит все записи в `google_sheets`
- [ ] Синхронизирует каждую таблицу последовательно
- [ ] Ошибки в одной таблице не прерывают синхронизацию других
- [ ] Возвращается общая статистика по всем таблицам

---

## Связанные файлы

- `dashboard/api/services/GoogleSheetsSyncService.php` - основной файл сервиса
- `dashboard/api/services/GoogleSheetsService.php` - для работы с Google API
- `dashboard/api/services/DatabaseService.php` - для работы с БД

---

## Примечания

- Использовать транзакции для атомарности операций
- Логировать все операции синхронизации
- Обрабатывать ошибки gracefully (не падать при ошибке в одной строке)
