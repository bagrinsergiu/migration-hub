# Инструкция по запуску тестов веб-хуков

## Важно: Мок-режим

Все тесты работают в **мок-режиме** - они **НЕ отправляют реальные HTTP запросы** и не требуют запущенных серверов. Тесты проверяют только логику формирования запросов и валидацию данных.

## Быстрый старт

### 1. Базовый тест интеграции (мок-режим)

Запускает все тесты без необходимости запуска серверов:

```bash
php8.3 src/scripts/test_webhook_integration.php
```

Этот скрипт проверяет:
- ✓ Передачу параметров веб-хука при запуске миграции
- ✓ Структуру данных для веб-хука
- ✓ Формирование URL для опроса статуса миграции
- ✓ Структуру ответа от сервера миграции
- ✓ Сохранение результатов в БД (если БД доступна)

**Примечание:** Тесты не падают при недоступности серверов, так как не отправляют реальные HTTP запросы.

### 2. Альтернативный тест (расширенный мок)

Более детальный тест с дополнительными проверками:

```bash
php8.3 src/scripts/test_webhook_integration_mock.php
```

Этот скрипт проверяет:
- ✓ Формирование параметров веб-хука
- ✓ Валидацию статусов миграции
- ✓ Обработку ошибок
- ✓ Все сценарии без реальных HTTP запросов

### 3. Mock-сервер миграции (опционально)

Если нужно протестировать с реальными HTTP запросами, можно запустить mock-сервер:

```bash
# В отдельном терминале
php8.3 -S localhost:8080 src/scripts/test_mock_migration_server.php
```

**Примечание:** Обычные тесты работают без этого сервера, так как они в мок-режиме.

## Результаты тестирования

### Успешный запуск тестов

Если все работает корректно, вы увидите:

```
✓ Параметры веб-хука должны быть добавлены в запрос
✓ Все обязательные поля присутствуют
✓ Структура данных корректна для отправки веб-хука
✓ URL для опроса статуса сформирован корректно
✓ Все обязательные поля присутствуют в ответе
```

### Преимущества мок-режима

- ✅ Тесты не требуют запущенных серверов
- ✅ Тесты не падают при недоступности серверов
- ✅ Быстрое выполнение (нет сетевых задержек)
- ✅ Стабильные результаты (не зависят от состояния серверов)
- ✅ Проверяют только логику и валидацию

### Возможные проблемы

1. **Ошибки валидации данных**
   - Проверьте структуру данных в тестах
   - Убедитесь, что все обязательные поля присутствуют

2. **Ошибки БД (только для теста 5)**
   - Это нормально, если БД недоступна
   - Тест 5 проверяет сохранение в БД только если она доступна

## Переменные окружения

Для корректной работы установите:

```bash
export DASHBOARD_BASE_URL=http://localhost:8088
export MIGRATION_API_URL=http://localhost:8080
```

## Дополнительная информация

Подробная документация по тестированию: `doc/TESTING_WEBHOOKS.md`
