# TASK-007: Реализация привязки листов к волнам миграций

## Статус: ⏳ В ожидании

**Дата создания:** 2025-01-30  
**Приоритет:** Высокий  
**Зависимости:** TASK-002, TASK-004

---

## Описание

Реализовать функционал привязки листов Google Sheets к волнам миграций. Каждый лист должен быть связан с конкретной волной через поле `wave_id` в таблице `google_sheets`.

## Что нужно сделать

### 1. Добавить метод в GoogleSheetsService

**Метод:** `linkSheetToWave($spreadsheetId, $sheetName, $waveId)`

**Логика:**
1. Проверить существование волны в таблице `waves`
2. Найти или создать запись в таблице `google_sheets`
3. Обновить поле `wave_id`
4. Сохранить `sheet_id` и `sheet_name` если они еще не сохранены

### 2. Добавить метод получения листов волны

**Метод:** `getSheetsByWave($waveId)`

Возвращает все листы, привязанные к конкретной волне.

### 3. Добавить метод отвязки листа от волны

**Метод:** `unlinkSheetFromWave($spreadsheetId, $sheetName)`

Удаляет связь листа с волной (устанавливает `wave_id = NULL`).

---

## Ожидаемые результаты

### Проверка привязки листа к волне

- [ ] Метод `linkSheetToWave()` успешно создает/обновляет запись в `google_sheets`
- [ ] Поле `wave_id` корректно устанавливается
- [ ] Если волна не существует, выбрасывается исключение
- [ ] Если запись уже существует, она обновляется, а не дублируется
- [ ] `sheet_id` и `sheet_name` сохраняются при первом связывании

### Проверка получения листов волны

- [ ] Метод `getSheetsByWave($waveId)` возвращает все листы для волны
- [ ] Возвращаются корректные данные: spreadsheet_id, sheet_name, last_synced_at
- [ ] Если волна не существует, возвращается пустой массив
- [ ] Если у волны нет привязанных листов, возвращается пустой массив

### Проверка отвязки листа

- [ ] Метод `unlinkSheetFromWave()` корректно устанавливает `wave_id = NULL`
- [ ] Запись в `google_sheets` не удаляется, только обновляется
- [ ] `updated_at` обновляется при отвязке

### Проверка валидации

- [ ] Проверяется существование волны перед привязкой
- [ ] Проверяется существование spreadsheet_id перед операциями
- [ ] Ошибки логируются и выбрасываются понятными исключениями

---

## Связанные файлы

- `dashboard/api/services/GoogleSheetsService.php` - добавление методов
- `dashboard/api/services/DatabaseService.php` - для работы с БД

---

## Примечания

- Убедиться, что одна волна может иметь несколько листов
- Один лист может быть привязан только к одной волне
- При удалении волны нужно решить, что делать с привязанными листами (оставить или отвязать)
