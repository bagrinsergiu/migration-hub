name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

env:
  DOCKER_IMAGE_NAME: mb-dashboard
  DOCKER_IMAGE_TAG: latest

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (optional)
        if: ${{ secrets.DOCKER_HUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: production
          push: false
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} | gzip > image.tar.gz

      - name: Set deployment variables
        id: deploy
        run: |
          echo "ssh_port=${{ secrets.DEPLOY_PORT || '22' }}" >> $GITHUB_OUTPUT
          echo "http_port=${{ secrets.DEPLOY_PORT_HTTP || '8088' }}" >> $GITHUB_OUTPUT
          echo "project_path=${{ secrets.DEPLOY_PROJECT_PATH || '/opt/mb-dashboard' }}" >> $GITHUB_OUTPUT

      - name: Copy image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ steps.deploy.outputs.ssh_port }}
          source: "image.tar.gz"
          target: "/tmp/"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ steps.deploy.outputs.ssh_port }}
          script: |
            set -e
            HTTP_PORT="${{ steps.deploy.outputs.http_port }}"
            PROJECT_PATH="${{ steps.deploy.outputs.project_path }}"
            IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
            IMAGE_TAG="${{ github.sha }}"
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑
            echo "üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º Docker –æ–±—Ä–∞–∑..."
            docker load < /tmp/image.tar.gz
            rm /tmp/image.tar.gz
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker stop ${IMAGE_NAME} 2>/dev/null || true
            docker rm ${IMAGE_NAME} 2>/dev/null || true
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
            mkdir -p ${PROJECT_PATH}/var/log
            mkdir -p ${PROJECT_PATH}/var/cache
            mkdir -p ${PROJECT_PATH}/var/tmp
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker run -d \
              --name ${IMAGE_NAME} \
              --restart unless-stopped \
              -p ${HTTP_PORT}:80 \
              -v ${PROJECT_PATH}/.env:/project/.env:ro \
              -v ${PROJECT_PATH}/var/log:/project/var/log \
              -v ${PROJECT_PATH}/var/cache:/project/var/cache \
              -v ${PROJECT_PATH}/var/tmp:/project/var/tmp \
              ${IMAGE_NAME}:${IMAGE_TAG}
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker image prune -f
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
            echo "üè• –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            sleep 10
            for i in {1..5}; do
              if curl -f http://localhost:${HTTP_PORT}/api/health; then
                echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
                exit 0
              fi
              echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/5, –∂–¥–µ–º..."
              sleep 5
            done
            echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
            docker logs ${IMAGE_NAME} --tail 50
            exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
