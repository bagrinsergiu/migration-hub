# TASK-011: Обновление MigrationService для работы с ревьюерами

## Статус: ✅ Выполнено

**Дата создания:** 2025-01-30  
**Приоритет:** Средний  
**Зависимости:** TASK-002, TASK-006

---

## Описание

Обновить `MigrationService` для получения информации о ревьюерах из таблицы `migration_reviewers`. Добавить методы для получения данных о том, кто работает над миграцией и делает ревью.

## Что нужно сделать

### 1. Добавить методы в MigrationService

**Файл:** `dashboard/api/services/MigrationService.php`

**Новые методы:**

#### `getMigrationReviewer($migrationId)`
Получить информацию о ревьюере для конкретной миграции:
- Принимает: `migration_id`
- Возвращает: объект с полями `person_brizy`, `uuid` или null, если ревьюер не назначен

#### `getMigrationsWithReviewers(array $filters = [])`
Получить список миграций с информацией о ревьюерах:
- Расширяет существующий метод `getMigrationsList()`
- Добавляет поле `reviewer` в каждую миграцию
- Возвращает: массив миграций с информацией о ревьюерах

#### `getReviewersByWave($waveId)`
Получить всех ревьюеров для миграций в волне:
- Принимает: `wave_id`
- Возвращает: массив уникальных ревьюеров с количеством миграций

### 2. Обновить существующие методы

Обновить метод `getMigrationDetails()`:
- Добавить поле `reviewer` в возвращаемые данные

---

## Ожидаемые результаты

### Проверка получения ревьюера

- [ ] Метод `getMigrationReviewer($migrationId)` возвращает данные из `migration_reviewers`
- [ ] Если ревьюер не назначен, возвращается `null`
- [ ] Возвращаются корректные данные: `person_brizy`, `uuid`
- [ ] Если миграция не существует, возвращается `null` или выбрасывается исключение

### Проверка получения миграций с ревьюерами

- [ ] Метод `getMigrationsWithReviewers()` возвращает миграции с полем `reviewer`
- [ ] Поле `reviewer` содержит `person_brizy` и `uuid` или `null`
- [ ] Фильтры работают корректно (как в `getMigrationsList()`)
- [ ] Производительность не ухудшилась (использовать JOIN вместо N+1 запросов)

### Проверка получения ревьюеров по волне

- [ ] Метод `getReviewersByWave($waveId)` возвращает уникальных ревьюеров
- [ ] Для каждого ревьюера указано количество миграций
- [ ] Если волна не существует, возвращается пустой массив
- [ ] Если у волны нет миграций с ревьюерами, возвращается пустой массив

### Проверка обновления существующих методов

- [ ] Метод `getMigrationDetails()` теперь включает поле `reviewer`
- [ ] Обратная совместимость сохранена (если `reviewer` отсутствует, не должно быть ошибок)
- [ ] Данные ревьюера корректно объединяются с данными миграции

### Проверка производительности

- [ ] Используется JOIN вместо множественных запросов (избежать N+1)
- [ ] Запросы оптимизированы (используются индексы)
- [ ] Нет лишних запросов к БД

---

## Связанные файлы

- `dashboard/api/services/MigrationService.php` - обновление методов
- `dashboard/api/services/DatabaseService.php` - возможно добавление методов для работы с `migration_reviewers`

---

## Примечания

- Сохранить обратную совместимость с существующим API
- Использовать JOIN для оптимизации запросов
- Учесть, что у миграции может не быть ревьюера (NULL)
