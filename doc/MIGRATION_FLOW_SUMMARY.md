# –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

## –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞: –í—Å–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

### üìã –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
1. [–§—Ä–æ–Ω—Ç–µ–Ω–¥] –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
   ‚Üì POST /api/migrations/run
   
2. [API] –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞
   ‚Üì MigrationController ‚Üí MigrationService ‚Üí ApiProxyService
   
3. [API] –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏
   ‚Üì GET {MIGRATION_API_URL}/?{params}&webhook_url=...
   
4. [–°–µ—Ä–≤–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
   ‚Üì (–≤ —Ñ–æ–Ω–µ)
   
5. [–§—Ä–æ–Ω—Ç–µ–Ω–¥] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
   ‚Üì GET /api/migrations/{id} (–∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)
   
6. [–°–µ—Ä–≤–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ ‚Üí –í–µ–±-—Ö—É–∫
   ‚Üì POST /api/webhooks/migration-result
   
7. [API] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±-—Ö—É–∫–∞
   ‚Üì WebhookController ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
   
8. [–§—Ä–æ–Ω—Ç–µ–Ω–¥] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   ‚Üì –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø—Ä–æ—Å–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
```

---

## üîç –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

### PHP –ª–æ–≥–∏ (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å)
```bash
# –í—Å–µ –æ—à–∏–±–∫–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
tail -f var/log/php/php-errors.log

# –¢–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
tail -f var/log/php/php-errors.log | grep -i migration

# –¢–æ–ª—å–∫–æ –≤–µ–±-—Ö—É–∫–∏
tail -f var/log/php/php-errors.log | grep -i webhook

# –î–æ—Å—Ç—É–ø –∫ API
tail -f var/log/php/fpm-access.log | grep "/api/migrations"
```

### –ë—Ä–∞—É–∑–µ—Ä (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å)
- –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12)
- –§–∏–ª—å—Ç—Ä: `MigrationDetails` –∏–ª–∏ `RunMigration`

---

## üìä –ö–ª—é—á–µ–≤—ã–µ endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–∑–æ–≤–∞ |
|----------|-------|----------|----------------|
| `/api/migrations/run` | POST | –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| `/api/migrations/{id}` | GET | –î–µ—Ç–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫ (–∞–∫—Ç–∏–≤–Ω—ã–µ) |
| `/api/migrations/{id}/process` | GET | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ | –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫ (–∞–∫—Ç–∏–≤–Ω—ã–µ) |
| `/api/migrations/{id}/status-from-server` | GET | –°—Ç–∞—Ç—É—Å —Å —Å–µ—Ä–≤–µ—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü–æ –∑–∞–ø—Ä–æ—Å—É |
| `/api/webhooks/migration-result` | POST | –í–µ–±-—Ö—É–∫ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ |

---

## üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å

**–£—Å–ª–æ–≤–∏—è:**
- –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ = `in_progress`
- –ò–õ–ò –µ—Å—Ç—å lock-—Ñ–∞–π–ª
- –ò–õ–ò –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** 3 —Å–µ–∫—É–Ω–¥—ã

**–ß—Ç–æ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è:**
1. –î–µ—Ç–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (`GET /api/migrations/{id}`)
2. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ (`GET /api/migrations/{id}/process`)
3. –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü (`GET /api/migrations/{id}/pages`)

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞:** –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ `completed`, `error` –∏–ª–∏ `success`

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

### 1. –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
```
[ApiProxyService::runMigration] –û—Ç–ø—Ä–∞–≤–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏: {url}
[ApiProxyService::runMigration] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞: mb_project_uuid={uuid}, brz_project_id={id}
[ApiProxyService::runMigration] HTTP –∫–æ–¥: {code}
```

### 2. –û–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
```
[MigrationController::getDetails] –ó–∞–ø—Ä–æ—Å –¥–µ—Ç–∞–ª–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏: {id}
[MigrationService::getMigrationDetails] –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è brz_project_id: {id}
```

### 3. –í–µ–±-—Ö—É–∫
```
[WebhookController::migrationResult] –ü–æ–ª—É—á–µ–Ω –≤–µ–±-—Ö—É–∫ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: mb_project_uuid={uuid}, brz_project_id={id}
[WebhookController::migrationResult] –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω: status={status}
```

---

## ‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –ß–µ—Ä–µ–∑ API
curl http://localhost:8088/api/migrations/{id}

# –ß–µ—Ä–µ–∑ –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø)
mysql -u root -p migration_db -e "SELECT * FROM migrations_mapping WHERE brz_project_id = {id};"
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f var/log/php/php-errors.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞: `curl {MIGRATION_API_URL}/health`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–ø—Ä–æ—Å–µ

### –°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ–±-—Ö—É–∫: `tail -f var/log/php/php-errors.log | grep webhook`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ä–æ—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–∫–æ–Ω—Å–æ–ª—å F12)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT * FROM migrations_mapping WHERE brz_project_id = {id};`

### –í–µ–±-—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –≤—ã–∑–æ–≤ –≤–µ–±-—Ö—É–∫–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤–µ–±-—Ö—É–∫–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ –∑–∞–ø—É—Å–∫–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞—à–±–æ—Ä–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üìö –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `doc/MIGRATION_EXECUTION_FLOW.md`
