# TASK-010: Создание скрипта для периодической синхронизации

## Статус: ⏳ В ожидании

**Дата создания:** 2025-01-30  
**Приоритет:** Средний  
**Зависимости:** TASK-006, TASK-009

---

## Описание

Создать скрипт для автоматической периодической синхронизации данных из Google Sheets. Скрипт должен запускаться через cron и синхронизировать все подключенные таблицы.

## Что нужно сделать

### 1. Создать файл скрипта

**Файл:** `dashboard/api/scripts/google_sheets_sync.php`

### 2. Реализовать логику синхронизации

**Основная логика:**
1. Подключить автозагрузку и инициализацию приложения
2. Получить список всех подключенных таблиц из БД
3. Для каждой таблицы:
   - Проверить, нужно ли синхронизировать (по `last_synced_at` и `GOOGLE_SYNC_INTERVAL`)
   - Получить список листов таблицы
   - Для каждого листа вызвать синхронизацию
   - Обновить `last_synced_at`
4. Логировать результаты синхронизации

### 3. Обработка ошибок

- Ошибки в одной таблице не должны прерывать синхронизацию других
- Все ошибки логируются в файл
- Статистика синхронизации сохраняется

### 4. Сделать скрипт исполняемым

```bash
chmod +x dashboard/api/scripts/google_sheets_sync.php
```

### 5. Добавить shebang (опционально)

```php
#!/usr/bin/env php
```

---

## Ожидаемые результаты

### Проверка создания скрипта

- [ ] Файл `google_sheets_sync.php` создан
- [ ] Скрипт можно запустить из командной строки: `php dashboard/api/scripts/google_sheets_sync.php`
- [ ] Скрипт подключает все необходимые зависимости
- [ ] Скрипт инициализирует приложение корректно

### Проверка логики синхронизации

- [ ] Скрипт получает список всех таблиц из БД
- [ ] Скрипт проверяет интервал синхронизации (`GOOGLE_SYNC_INTERVAL`)
- [ ] Скрипт синхронизирует только таблицы, которые нужно синхронизировать
- [ ] Для каждой таблицы получается список листов
- [ ] Каждый лист синхронизируется через `GoogleSheetsSyncService`
- [ ] `last_synced_at` обновляется после успешной синхронизации

### Проверка обработки ошибок

- [ ] Ошибка в одной таблице не прерывает синхронизацию других
- [ ] Ошибки логируются в файл логов
- [ ] Статистика включает информацию об ошибках
- [ ] Скрипт завершается с корректным exit code (0 - успех, 1 - ошибка)

### Проверка логирования

- [ ] Все операции логируются
- [ ] Логи содержат: время, таблицу, результат, ошибки (если есть)
- [ ] Логи записываются в файл (например, `var/log/google_sheets_sync.log`)

### Проверка производительности

- [ ] Скрипт не зависает при большом количестве таблиц
- [ ] Можно добавить лимит на время выполнения (опционально)
- [ ] Можно добавить лимит на количество синхронизируемых таблиц за раз

---

## Связанные файлы

- `dashboard/api/scripts/google_sheets_sync.php` - основной файл скрипта
- `dashboard/api/services/GoogleSheetsSyncService.php` - сервис синхронизации

---

## Примечания

- Скрипт должен быть идемпотентным (можно запускать несколько раз)
- Рекомендуется добавить возможность запуска для конкретной таблицы: `php google_sheets_sync.php --spreadsheet-id=xxx`
- Можно добавить dry-run режим для тестирования
