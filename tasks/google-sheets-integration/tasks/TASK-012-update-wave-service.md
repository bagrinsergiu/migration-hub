# TASK-012: Обновление WaveService для связи с Google Sheets

## Статус: ✅ Выполнено

**Дата создания:** 2025-01-30  
**Приоритет:** Средний  
**Зависимости:** TASK-002, TASK-007

---

## Описание

Обновить `WaveService` для работы с Google Sheets листами. Добавить методы для получения информации о привязанных листах и синхронизации данных из листов при работе с волнами.

## Что нужно сделать

### 1. Добавить методы в WaveService

**Файл:** `dashboard/api/services/WaveService.php`

**Новые методы:**

#### `getWaveSheets($waveId)`
Получить все Google Sheets листы, привязанные к волне:
- Принимает: `wave_id`
- Возвращает: массив листов с информацией (spreadsheet_id, sheet_name, last_synced_at)

#### `syncWaveFromSheets($waveId)`
Синхронизировать данные волны из привязанных Google Sheets:
- Принимает: `wave_id`
- Получает все привязанные листы
- Синхронизирует каждый лист
- Возвращает: статистику синхронизации

#### `linkWaveToSheet($waveId, $spreadsheetId, $sheetName)`
Привязать лист к волне (обертка над `GoogleSheetsService::linkSheetToWave()`):
- Принимает: `wave_id`, `spreadsheet_id`, `sheet_name`
- Вызывает `GoogleSheetsService::linkSheetToWave()`
- Возвращает: информацию о привязке

### 2. Обновить существующие методы

Обновить метод `getWave()`:
- Добавить поле `sheets` с информацией о привязанных листах

---

## Ожидаемые результаты

### Проверка получения листов волны

- [ ] Метод `getWaveSheets($waveId)` возвращает все привязанные листы
- [ ] Возвращаются корректные данные: spreadsheet_id, sheet_name, last_synced_at
- [ ] Если волна не существует, возвращается пустой массив
- [ ] Если у волны нет привязанных листов, возвращается пустой массив

### Проверка синхронизации волны

- [ ] Метод `syncWaveFromSheets($waveId)` находит все привязанные листы
- [ ] Каждый лист синхронизируется через `GoogleSheetsSyncService`
- [ ] Возвращается статистика: количество листов, успешно синхронизированных, ошибок
- [ ] Ошибки в одном листе не прерывают синхронизацию других

### Проверка привязки листа к волне

- [ ] Метод `linkWaveToSheet()` корректно вызывает `GoogleSheetsService::linkSheetToWave()`
- [ ] Проверяется существование волны перед привязкой
- [ ] Возвращается информация о привязке
- [ ] Ошибки обрабатываются и возвращаются понятным образом

### Проверка обновления существующих методов

- [ ] Метод `getWave()` теперь включает поле `sheets`
- [ ] Поле `sheets` содержит массив привязанных листов
- [ ] Обратная совместимость сохранена
- [ ] Если листов нет, поле `sheets` содержит пустой массив

---

## Связанные файлы

- `dashboard/api/services/WaveService.php` - обновление методов
- `dashboard/api/services/GoogleSheetsService.php` - для работы с листами
- `dashboard/api/services/GoogleSheetsSyncService.php` - для синхронизации

---

## Примечания

- Сохранить обратную совместимость с существующим API
- Учесть, что у волны может не быть привязанных листов
- Синхронизация должна быть опциональной (не блокировать основные операции)
